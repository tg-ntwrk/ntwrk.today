---
layout: "post"
title: "Сервисная архитектура ISP и универсальная транспортная сеть"
tags: architecture isp vxlan mpls arista clos
author: "ipotech"
---

Сервисная архитектура ISP и универсальная транспортная сеть

> **Disclaimer**:
Автор статьи пишет под влиянием мнений авторитетных представителей индустрии и собственного опыта.

## Описание
![architecture-isp](/images/architecture-isp.png)

Сервисная архитектура диктует, что каждая сущность системы должна быть обособлена и предоставлять сервис другой сущности через понятное API.

### Подробнее о слоях
* **Поставщики** - любые источники контента, например, сам Интернет, OTT и VOIP, КТВ и POTS;
* **Бренд** - комплекс оборудования для обслуживания сессий пользовательского трафика, например BNG или SBC;
* **Универсальная транспортная сеть** - магистральная транспортная сеть и распределительная транспортная сеть. Транспортная сеть может иметь арендованные ресурсы, например, ПМ через других ISP;
* **Физическая сеть** - слой пассивной оптический и не только коммутации. Может иметь арендованные ресурсы у других провайдеров (темные оптические волокна);
* **Платформа** - узлы Compute, вычислительный кластер, например, OpenStack, VMware vSphere/vCloud, и так далее. Может обладать своей сетью, но также может арендовать сеть у транспортной сети;
* **Инфраструктура** - автозалы, энергетика, климат;
* **Клиенты** - конечные пользователи услуг бренда.

Такое разделение позволяет четко определить зоны ответственности и повысить качество. Появляется конкуренция, никто больше не обязывает брать услугу только у одного поставщика.

## Универсальная транспортная сеть
Сфокусируемся на варианте реализации транспортной сети, а точнее на ее магистральной части.
Допустим, в сети есть равноудаленные площадки, на которых сосредоточено "ядро" - BNG, узлы Compute, коммутаторы агрегации, маршрутизаторы и так далее.

Главная бизнес цель: транспортное оборудование должно обеспечить связность между клиентами и ядром. Фактически, предоставить L2VPN и L3VPN.

Классические варианты предлагают строить север-юг сети с помощью STP или MPLS. Оба решения имеют минусы и не готовы к подходам реализации сетей для SDN/NFV.

Предлагается рассмотреть сеть как один большой "датацентр", где площадки соединены в топологию CLOS. К похожему выводу приходит в своей [статье](http://karneliuk.com/2019/01/sp-part-3-automated-service-provider-fabric-with-arista-cisco-nokia-and-ansible/) Антон Карнелюк. Также ONF советует строить современные сети по принципу _The CORD (Central Office Re-architected as a Datacenter)_ [opencord](https://www.opennetworking.org/cord/).

В современном мире датацентры строят с использованием EVPN/VXLAN. Это позволяет распределять оборудование бренда и узлов Compute на любых площадках, а задача транспортной сети в предоставлении им связи L2 и L3.

![arch-pop](/images/arch-pop.png)
Можно выделить такие роли:
- Виртуальный распределенный коммутатор - L2 транспорт между устройствами бренда и терминацией на площадках (локальные особенности), то есть всем PE устройствами;
- Виртуальный распределенный маршрутизатор - L3VPN для Платформы;
- Транспорт для IPTV multicast.

## Теория построения на оборудовании Arista 7280SR

> **Примечание**: Реальные конфигурации и опыт в следующих статьях.

### Виртуальный распределенный коммутатор
В рассматриваемом случае технологическая сеть передачи данных (ТСПД) организует L2-связность между маршрутизаторами.

Маршрутизаторы AX поверх ТСПД строят MPLS сеть для предоставления услугу P2P \(PW Kompella\) и P2MP L2VPN \(EVPN\), L3VPN \(включая интернет и EVPN\):

![протоколы](/images/ipotech-a2-protocols.png)

![метки](/images/ipotech-protocol-labels.png)

Фабрика построена с EBGP Underlay и iBGP Overlay. В качестве транспорта используется VXLAN. Такая связка позволит сделать EVPN/VXLAN фабрику с L2VPN и L3VPN.

VTEP распределен по двум LEAF свичам площадки. Для обеспечения резервирования используется MLAG в сторону CE. Для обеспечения работы MLAG между LEAF свичами организован служебный линк. В норме по этому линку передаются только служебные сообщения, трафик данных попадает туда только для Single Home CE подключений, например при аварии CE-LEAF линка.

Балансировка на линках LEAF-SPINE происходит по хэшу -3 заголовка от VTEP с ECMP.
И вот тут есть особенности и вероятно ограничения. Смотри [тут](/_posts/2019-06-24-juniper-mx-mpls-examples.md).

### Виртуальный распределенный маршрутизатор
LEAF оборудование транспортной сети выступает в роли PE маршрутизатора для терминирования IPv4 и IPv6 подсетей ВМ и контейнеров. Терминирование происходит в L3 EVPN инстанс с Symmetric IRB. Для обеспечения связности между сервисными маршрутизаторами бренда, маршрутизаторами терминации и LEAF можно, например, организовать BGP option A стык для каждого VRF. Для обеспечения безопасности на интерфейсах LEAF оборудования конфигурируются ACL по L2-L4 заголовкам.
![vrouter](/images/ipotech-vrouter.png)

### Транспорт IPTV multicast
IP фабрика маршрутизирует PIM в Underlay.

## Ссылки
- https://www.opennetworking.org/cord/
- http://karneliuk.com/2019/01/sp-part-3-automated-service-provider-fabric-with-arista-cisco-nokia-and-ansible/
